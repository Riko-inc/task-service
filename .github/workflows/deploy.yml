name: Deploy Task Service

on:
  push:
    branches: [ main, develop, feature/dev-29 ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          docker build -t riko-inc/task-service:latest .

      - name: Save Docker image to archive
        run: |
          docker save riko-inc/task-service:latest -o $GITHUB_WORKSPACE/image.tar && echo "Docker image saved successfully"

      - name: Fix file permissions
        run: chmod 644 $GITHUB_WORKSPACE/image.tar

      - name: Transfer image to server via SCP
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "image.tar"
          target: "/tmp/"
          strip_components: 0
          rm: true
          debug: true
          overwrite: true

      - name: Deploy on server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
            chmod 644 /tmp/github/workspace/image.tar
            
            sudo ctr images rm "riko-inc/task-service:latest" || true
            sudo ctr images rm "riko-inc/task-service" || true
            sudo ctr images import /tmp/github/workspace/image.tar --base-name riko-inc/task-service --debug
            
            helm uninstall task-service -n services
            helm upgrade --install task-service /home/user1/task-service --namespace services --set image.tag=latest --set image.repository=riko-inc/task-service
          debug: true
